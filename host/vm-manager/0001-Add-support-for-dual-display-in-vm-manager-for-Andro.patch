From a2d9a5ed884171dc2539ba15c52a51f36739cc10 Mon Sep 17 00:00:00 2001
From: "Suresh, Prashanth" <prashanth.suresh@intel.com>
Date: Wed, 19 Apr 2023 16:20:24 +0530
Subject: [PATCH] Add support for dual display in vm-manager for Android.

---
 src/guest/guest.c         |  1 +
 src/guest/start.c         | 56 ++++++++++++++++++++++++++++++++++-----
 src/include/guest/guest.h |  5 ++++
 3 files changed, 56 insertions(+), 6 deletions(-)

diff --git a/src/guest/guest.c b/src/guest/guest.c
index 4d2bcf4..d9a24ac 100644
--- a/src/guest/guest.c
+++ b/src/guest/guest.c
@@ -35,6 +35,7 @@ keyfile_group_t g_group[] = {
 	{ "mediation", { "battery_med", "thermal_med", "camera_med",NULL }},
 	{ "aaf",      { "path", "support_suspend", "audio_type", NULL } },
 	{ "guest_control", { "time_keep", "pm_control", NULL }},
+	{ "display",  { "connectors.0", "connectors.1", "show_fps", NULL } },
 	{ "extra",    { "cmd", "service", NULL } },
 };
 
diff --git a/src/guest/start.c b/src/guest/start.c
index 25e1207..5ce17c6 100644
--- a/src/guest/start.c
+++ b/src/guest/start.c
@@ -26,6 +26,7 @@
 #include <regex.h>
 #include <string.h>
 #include <ctype.h>
+#include <menu.h>
 #include "vm_manager.h"
 #include "guest.h"
 #include "utils.h"
@@ -535,14 +536,57 @@ static int setup_sriov(GKeyFile *gkf, char **p, size_t *size)
 	int monitor_id = -1;
 	int vf = 0;
 	int mem = 0;
+	int number_of_displays = 0;
+	g_autofree gchar *connectors_0 = NULL;
+	g_autofree gchar *connectors_1 = NULL;
+	g_autofree gchar *show_fps = "";
+	char show_fps_str[15] = "show-fps=";
+	char connectors[8][8] = {
+		"HDMI-1",
+		"HDMI-2",
+		"HDMI-3",
+		"HDMI-4",
+		"DP-1",
+		"DP-2",
+		"DP-3",
+		"DP-4",
+	};
+	char connector_str[30] = {0};
+
 	GError *error = NULL;
 	keyfile_group_t *g = NULL;
 
 	g = &g_group[GROUP_VGPU];
 	monitor_id = g_key_file_get_integer(gkf, g->name, g->key[VGPU_MON_ID], &error);
+
+	g = &g_group[GROUP_DISPLAY];
+	show_fps = g_key_file_get_string(gkf, g->name, g->key[SHOW_FPS], &error);
+	if (show_fps != NULL &&  (!strcmp(show_fps,"on") || !strcmp(show_fps,"off")))
+		strcat(show_fps_str, show_fps);
+	else {
+		fprintf(stderr, "Please enter a valid value for show_fps.\n");
+		return -1;
+	}
+
+	connectors_0 = g_key_file_get_string(gkf, g->name, g->key[CONNECTORS_0], &error);
+	connectors_1 = g_key_file_get_string(gkf, g->name, g->key[CONNECTORS_1], &error);
+	for(int i = 0; i < 8; i++) {
+		if(connectors_0 && !strcmp(connectors_0, connectors[i])) {
+			number_of_displays++;
+			strcat(connector_str, "connectors.0=");
+			strcat(connector_str, connectors_0);
+			strcat(connector_str, ",");
+		}
+		if(connectors_1 && !strcmp(connectors_1, connectors[i])) {
+                        number_of_displays++;
+                        strcat(connector_str, "connectors.1=");
+                        strcat(connector_str, connectors_1);
+			strcat(connector_str, ",");
+                }
+	}
 	if (error) {
 		if (error->code == G_KEY_FILE_ERROR_KEY_NOT_FOUND) {
-			cx = snprintf(*p, *size, " -display gtk,gl=on");
+			cx = snprintf(*p, *size, " -display gtk,gl=on,%s,%s", show_fps_str, connector_str);
 		} else {
 			fprintf(stderr, "Invalid monitor id!\n");
 			return -1;
@@ -557,11 +601,11 @@ static int setup_sriov(GKeyFile *gkf, char **p, size_t *size)
 		return -1;
 	vf = set_available_vf();
 
-	cx = snprintf(*p, *size, " -device virtio-vga,max_outputs=1,blob=true"
-				 " -device vfio-pci,host=0000:00:02.%d"
-				 " -object memory-backend-memfd,hugetlb=on,id=mem_sriov,size=%dM"
-				 " -machine memory-backend=mem_sriov",
-				 vf, mem);
+	cx = snprintf(*p, *size, " -device virtio-vga,max_outputs=%d,blob=true"
+                               " -device vfio-pci,host=0000:00:02.%d"
+                               " -object memory-backend-memfd,hugetlb=on,id=mem_sriov,size=%dM"
+                               " -machine memory-backend=mem_sriov",
+                               number_of_displays > 0 ?number_of_displays:1, vf, mem);
 	*p += cx; *size -= cx;
 
 	return 0;
diff --git a/src/include/guest/guest.h b/src/include/guest/guest.h
index 0165d9a..1ef62da 100644
--- a/src/include/guest/guest.h
+++ b/src/include/guest/guest.h
@@ -143,6 +143,7 @@ enum {
 	GROUP_MEDIATION,
   	GROUP_AAF,
 	GROUP_GUEST_SERVICE,
+	GROUP_DISPLAY,
 	GROUP_EXTRA,
 	GROUP_NUM
 };
@@ -212,6 +213,10 @@ enum {
 	EXTRA_CMD = 0,
 	EXTRA_SERVICE,
 
+	/* Sub key of display params */
+	CONNECTORS_0 = 0,
+	CONNECTORS_1,
+	SHOW_FPS,
 
 };
 
-- 
2.34.1

