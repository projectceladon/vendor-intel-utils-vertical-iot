From 3705a4970e27281f7f379ed8a0509dc5223b5ddb Mon Sep 17 00:00:00 2001
From: kalle <kalyan.alle@intel.com>
Date: Thu, 13 Jan 2022 15:28:37 +0800
Subject: [PATCH] onevpl driver changes to support rpl-s platform

---
 .../cmrt_cross_platform/include/cmrt_cross_platform.h      | 1 +
 _studio/mfx_lib/encode_hw/h264/src/mfx_h264_encode_cm.cpp  | 1 +
 _studio/mfx_lib/vpp/src/mfx_vpp_hw.cpp                     | 1 +
 _studio/shared/asc/src/asc.cpp                             | 1 +
 _studio/shared/include/mfxstructures-int.h                 | 7 +++++++
 _studio/shared/src/cm_mem_copy.cpp                         | 1 +
 _studio/shared/src/libmfx_core.cpp                         | 1 +
 _studio/shared/src/libmfx_core_vaapi.cpp                   | 1 +
 api/vpl/mfxcommon.h                                        | 1 +
 9 files changed, 15 insertions(+)

diff --git a/_studio/mfx_lib/cmrt_cross_platform/include/cmrt_cross_platform.h b/_studio/mfx_lib/cmrt_cross_platform/include/cmrt_cross_platform.h
index fc5c3e2..9ee3c8c 100644
--- a/_studio/mfx_lib/cmrt_cross_platform/include/cmrt_cross_platform.h
+++ b/_studio/mfx_lib/cmrt_cross_platform/include/cmrt_cross_platform.h
@@ -715,6 +715,7 @@ typedef enum _GPU_PLATFORM {
     PLATFORM_INTEL_DG1 = 20,  //DG1
     PLATFORM_INTEL_ADL_S = 21,  //AlderLake
     PLATFORM_INTEL_ADL_P = 23, //AlderLake
+    PLATFORM_INTEL_RPL_S = 25, //RaptorLake
 } GPU_PLATFORM;
 
 //Time in seconds before kernel should timeout
diff --git a/_studio/mfx_lib/encode_hw/h264/src/mfx_h264_encode_cm.cpp b/_studio/mfx_lib/encode_hw/h264/src/mfx_h264_encode_cm.cpp
index 551ba27..b44ca51 100755
--- a/_studio/mfx_lib/encode_hw/h264/src/mfx_h264_encode_cm.cpp
+++ b/_studio/mfx_lib/encode_hw/h264/src/mfx_h264_encode_cm.cpp
@@ -863,6 +863,7 @@ void CmContext::Setup(
     case MFX_HW_RKL:
     case MFX_HW_ADL_S:
     case MFX_HW_ADL_P:
+    case MFX_HW_RPL_S:
         m_program = ReadProgram(m_device, genx_simple_me_gen12lp, SizeOf(genx_simple_me_gen12lp));
         m_programHist = ReadProgram(m_device, genx_histogram_gen12lp, SizeOf(genx_histogram_gen12lp));
         break;
diff --git a/_studio/mfx_lib/vpp/src/mfx_vpp_hw.cpp b/_studio/mfx_lib/vpp/src/mfx_vpp_hw.cpp
index 4236b52..5c09cae 100755
--- a/_studio/mfx_lib/vpp/src/mfx_vpp_hw.cpp
+++ b/_studio/mfx_lib/vpp/src/mfx_vpp_hw.cpp
@@ -2438,6 +2438,7 @@ mfxStatus  VideoVPPHW::Init(
             case MFX_HW_RKL:
             case MFX_HW_ADL_S:
             case MFX_HW_ADL_P:
+	    case MFX_HW_RPL_S:
                 res = m_pCmDevice->LoadProgram((void*)genx_fcopy_gen12lp,sizeof(genx_fcopy_gen12lp),m_pCmProgram,"nojitter");
                 break;
 #endif
diff --git a/_studio/shared/asc/src/asc.cpp b/_studio/shared/asc/src/asc.cpp
index 2a39ba2..25a0835 100644
--- a/_studio/shared/asc/src/asc.cpp
+++ b/_studio/shared/asc/src/asc.cpp
@@ -302,6 +302,7 @@ mfxStatus ASC::InitGPUsurf(CmDevice* pCmDevice) {
     case PLATFORM_INTEL_ICLLP:
         return MFX_ERR_UNSUPPORTED;
     case PLATFORM_INTEL_ADL_S:
+    case PLATFORM_INTEL_RPL_S:
     case PLATFORM_INTEL_TGLLP:
     case PLATFORM_INTEL_RKL:
     case PLATFORM_INTEL_DG1:
diff --git a/_studio/shared/include/mfxstructures-int.h b/_studio/shared/include/mfxstructures-int.h
index c71f126..3a04a95 100755
--- a/_studio/shared/include/mfxstructures-int.h
+++ b/_studio/shared/include/mfxstructures-int.h
@@ -79,6 +79,7 @@ enum eMFXHWType
     MFX_HW_DG1       = MFX_HW_TGL_LP + 3,
     MFX_HW_ADL_S     = MFX_HW_TGL_LP + 4,
     MFX_HW_ADL_P     = MFX_HW_TGL_LP + 5,
+    MFX_HW_RPL_S     = MFX_HW_TGL_LP + 6,
 
 };
 
@@ -450,6 +451,12 @@ typedef struct {
     { 0x46AA, MFX_HW_ADL_P, MFX_GT2 },//ADL-P
     { 0x462A, MFX_HW_ADL_P, MFX_GT2 },//ADL-P
 
+    /* RPL-S */
+    { 0x4600, MFX_HW_RPL_S, MFX_GT1 },//RPL-S
+    { 0xA780, MFX_HW_RPL_S, MFX_GT1 },//RPL-S
+    { 0xA781, MFX_HW_RPL_S, MFX_GT1 },//RPL-S
+    { 0xA782, MFX_HW_RPL_S, MFX_GT1 },//RPL-S
+    { 0xA783, MFX_HW_RPL_S, MFX_GT1 },//RPL-S
 
 };
 
diff --git a/_studio/shared/src/cm_mem_copy.cpp b/_studio/shared/src/cm_mem_copy.cpp
index 0ae072a..56a4998 100755
--- a/_studio/shared/src/cm_mem_copy.cpp
+++ b/_studio/shared/src/cm_mem_copy.cpp
@@ -2523,6 +2523,7 @@ mfxStatus CmCopyWrapper::InitializeSwapKernels(eMFXHWType hwtype)
     case MFX_HW_RKL:
     case MFX_HW_ADL_S:
     case MFX_HW_ADL_P:
+    case MFX_HW_RPL_S:
         cmSts = m_pCmDevice->LoadProgram((void*)genx_copy_kernel_gen12lp,sizeof(genx_copy_kernel_gen12lp),m_pCmProgram,"nojitter");
         break;
 #endif
diff --git a/_studio/shared/src/libmfx_core.cpp b/_studio/shared/src/libmfx_core.cpp
index 47fab2f..45227a7 100755
--- a/_studio/shared/src/libmfx_core.cpp
+++ b/_studio/shared/src/libmfx_core.cpp
@@ -591,6 +591,7 @@ static inline mfxPlatform MakePlatform(eMFXHWType type, mfxU16 device_id)
                          platform.CodeName = MFX_PLATFORM_TIGERLAKE;     break;
     case MFX_HW_ADL_S  : platform.CodeName = MFX_PLATFORM_ALDERLAKE_S;   break;
     case MFX_HW_ADL_P  : platform.CodeName = MFX_PLATFORM_ALDERLAKE_P;   break;
+    case MFX_HW_RPL_S  : platform.CodeName = MFX_PLATFORM_RAPTORLAKE_S;   break;
     default:
                          platform.MediaAdapterType = MFX_MEDIA_UNKNOWN;
                          platform.CodeName = MFX_PLATFORM_UNKNOWN;       break;
diff --git a/_studio/shared/src/libmfx_core_vaapi.cpp b/_studio/shared/src/libmfx_core_vaapi.cpp
index 28e8b84..316f05b 100755
--- a/_studio/shared/src/libmfx_core_vaapi.cpp
+++ b/_studio/shared/src/libmfx_core_vaapi.cpp
@@ -253,6 +253,7 @@ mfxStatus VAAPIVideoCORE_T<Base>::SetHandle(
                 case MFX_HW_RKL:
                 case MFX_HW_ADL_S:
                 case MFX_HW_ADL_P:
+		case MFX_HW_RPL_S:
                 case MFX_HW_DG1:
                     // These platforms support VPL feature set
                     this->m_enabled20Interface = true;
diff --git a/api/vpl/mfxcommon.h b/api/vpl/mfxcommon.h
index 3845a53..abda962 100644
--- a/api/vpl/mfxcommon.h
+++ b/api/vpl/mfxcommon.h
@@ -197,6 +197,7 @@ enum {
     MFX_PLATFORM_ALDERLAKE_P    = 44, /*!< Code name Alder Lake P. */
     MFX_PLATFORM_ARCTICSOUND_P  = 45,
     MFX_PLATFORM_XEHP           = 45, /*!< Code name Xe HP. */
+    MFX_PLATFORM_RAPTORLAKE_S   = 46, /*!< Code name Raptor Lake. */
     MFX_PLATFORM_KEEMBAY        = 50, /*!< Code name Keem Bay. */
 };
 
-- 
2.17.1

