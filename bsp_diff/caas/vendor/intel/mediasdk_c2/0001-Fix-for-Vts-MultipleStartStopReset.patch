From 5567903578b9a2f05119457d7422c2d4c3978a80 Mon Sep 17 00:00:00 2001
From: gollarx <ratnakumarix.golla@intel.com>
Date: Thu, 3 Nov 2022 22:04:58 +0530
Subject: [PATCH] Fix for Vts MultipleStartStopReset

The issue with MultipleStartStopReset is when we do
start()->reset()->start(), the state is in RUNNING state, so start() is
returning the C2_BAD_STATE.

Added the functionality for reset() method in mfx_c2_component for
fixing the issue with the VtsHalMediaC2 module.

Tracked-On: OAM-103591
Signed-off-by: gollarx <ratnakumarix.golla@intel.com>
---
 c2_components/src/mfx_c2_component.cpp | 16 +++++++++++++++-
 1 file changed, 15 insertions(+), 1 deletion(-)

diff --git a/c2_components/src/mfx_c2_component.cpp b/c2_components/src/mfx_c2_component.cpp
index 344040c..df6730a 100755
--- a/c2_components/src/mfx_c2_component.cpp
+++ b/c2_components/src/mfx_c2_component.cpp
@@ -384,7 +384,21 @@ c2_status_t MfxC2Component::stop()
 c2_status_t MfxC2Component::reset()
 {
     MFX_DEBUG_TRACE_FUNC;
-    return C2_OK;
+    c2_status_t res = C2_OK;
+
+    res = DoStop(true);
+
+    {
+	 std::lock_guard<std::mutex> lock(m_stateMutex);
+	 if (C2_OK == res) { // DoStop succeeded
+		 m_state = m_nextState = State::STOPPED;
+	 } else {
+		 m_nextState = m_state;
+	 }
+	 m_condStateStable.notify_all();
+    }
+
+    return res;
 }
 
 c2_status_t MfxC2Component::release()
-- 
2.38.1

